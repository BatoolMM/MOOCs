<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: course.controllers.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: course.controllers.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const {
  Video,
  Course,
  Exercise,
  Question,
} = require("../models/course.models");
const { v2 } = require("cloudinary");
const asyncWrapper = require("../utils/async_wrapper");
const { BadRequestError } = require("../utils/custom_errors");
const User = require("../models/user.models");

/* COURSES */

/**
 * Create new course
 * 
 * @param {string} title - Course title
 * @param {string} author - Course author
 * @param {string} description - Course description
 * 
 * @returns {MongooseObject} savedCourse
 * 
 * @throws {error} if an error occured
 */
exports.createCourse = async (req, res, next) => {
  const newCourse = new Course(req.body);
  const savedCourse = await newCourse.save();
  res.status(200).json(savedCourse);
};

/**
 * Get courses
 * 
 * To get data for all course set req.body._id = null
 * To get data for a particular course set req.body._id - id of the course
 * To get data for all courses set req.body = null
 * 
 * @param {string} id - Course id
 * 
 * @returns {object} courses
 */
exports.getCourses = async (req, res, next) => {
  if (req.body) {
    const courses = await Course.find(req.body);
    res.status(200).json(courses);
  }
  const courses = await Course.find().sort({ _id: -1 });

  return res.status(200).send({ courses: courses });
};

/**
 * Update course data
 * 
 * @private
 * 
 * @param {string} id
 * 
 * @returns {string} message
 * @returns {object} course
 * 
 * @throws {BadRequestError} if Course not found
 */
exports.updateCourse = async (req, res, next) => {
  const course = await Course.findById(req.params.id);

  if (course) {
    await course.updateOne({ $set: req.body });

    return res.status(200).json({ message: "Course Updated", course: course });
  }

  next(new BadRequestError("Course not found"));
};

/** 
 * Delete course
 * 
 * @private 
 * 
 * @param {string} id - Id of the course
 * 
 * @returns {string} message
 */
exports.deleteCourse = async (req, res, next) => {
  const courseId = req.params.courseId;
  await Course.findByIdAndDelete(courseId);

  res.status(200).send({ message: "course has been deleted successfully" });
};

/**
 * Enroll for a course
 * 
 * @private
 * 
 * @param {string} course_id - id of course to enroll for 
 * @param {string} user_id - id of user to enroll
 * 
 * @returns {string} message
 * 
 * @throws {error} if an error occured
 */
exports.enrollCourse = async (req, res, next) => {
  const course = await Course.findById(req.body.course_id);
  const user = await User.findById(req.body.user_id);

  course.enrolled_users.push(user);
  await course.save();

  user.enrolled_courses.push(course);
  await user.save();

  res
    .status(200)
    .send({ message: "user has been enrolled in course successfully" });
};

/**
 * Cancel course enrollment 
 * 
 * @param {string} course_id
 * @param {string} user_id
 * 
 * @returns {string} message
 */
exports.cancelEnrollment = async (req, res, next) => {
  const course = await Course.findById(req.body.course_id);
  const user = await User.findById(req.body.user_id);

  course.enrolled_users.pull(user);
  await course.save();

  user.enrolled_courses.pull(course);
  await user.save();

  res
    .status(200)
    .send({ message: "user has been unenrolled from course successfully" });
};

/**
 * Get enrolled courses for a particular user
 * 
 * @param {string} user_id
 * 
 * @returns {object} enrolledCourses 
 */
exports.getEnrolledCourses = async (req, res, next) => {
  const user = await User.findById(req.body.user_id);
  const enrolledCourses = await Course.find({
    _id: { $in: user.enrolled_courses },
  });

  res.status(200).send({ enrolledCourses: enrolledCourses });
};

/**
 * Get Enrolled users 
 * 
 * @param {string} course_id
 * 
 * @returns {object} enrolledUsers
 */
exports.getEnrolledUsers = async (req, res, next) => {
  const course = await Course.findById(req.body.course_id);
  const enrolledUsers = await User.find({
    _id: { $in: course.enrolled_users },
  });

  res.status(200).send({ enrolledUsers: enrolledUsers });
};

/* VIDEOS */

/**
 * Upload video
 * 
 * @param {string} course_id
 * @param {string} title
 * @param {string} description
 * @param {string} author
 * 
 * @returns {object} savedVideo
 * 
 * @throws {error} if an error occured
 */
exports.uploadVideo = asyncWrapper(async (req, res, next) => {
  const { video } = req.files;
  const { course_id } = req.body;

  const result = await v2.uploader.upload(video.tempFilePath, {
    resource_type: "video",
    folder: "videos",
  });

  const newVideo = new Video({
    video_url: result.secure_url,
    video_id: result.public_id,
    ...req.body,
    //     course: course_id,
    //     description: req.body.description,
    //     title: req.body.title,
    //     author: req.body.author
  });

  const savedVideo = await newVideo.save();
  res.status(200).json(savedVideo);
});

/**
 * Get video data
 * 
 * Get data for all videos - req.body._id = null
 * Get data for particular video - req.body._id = video_id
 * Get videos for a particular course - req.body.course_id = course_id
 * Get all videos - req.body = null
 * 
 * @param {string} video_id
 * 
 * @returns {object} videos
 * 
 * @throws {error} if an error occured
 */
exports.getVideo = asyncWrapper(async (req, res, next) => {
  const videos = await Video.find(req.body);
  res.status(200).json(videos);
});

/**
 * Update video data
 * 
 * @param {string} video_id
 * @param {object} req.body
 * 
 * @returns {object} video
 * 
 * @throws {error} if an error occured
 * @throws {BadRequestError} if video not found
 */
exports.updateVideo = asyncWrapper(async (req, res, next) => {
  const video = await Video.findById(req.params.id);

  if (video) {
    await video.updateOne({ $set: req.body });

    return res.status(200).json({ message: "Video Updated", video: video });
  }

  next(new BadRequestError("Video not found"));
});

/**
 * Delete video
 * 
 * @param {string} video_id
 * 
 * @returns {string} message
 * 
 * @throws {error} if an error occured
 * @throws {BadRequestError} if video not found
 * 
 * @todo delete video from cloudinary
 * @todo delete video from database
 * @todo delete video from course
 * @todo delete video from user
 * */
exports.deleteVideo = asyncWrapper(async (req, res, next) => {
  const videoId = req.params.videoId;
  await Video.findByIdAndDelete(videoId);

  return res
    .status(200)
    .send({ message: "video has been deleted successfully" });
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#cancelEnrollment">cancelEnrollment</a></li><li><a href="global.html#createCourse">createCourse</a></li><li><a href="global.html#createExercise">createExercise</a></li><li><a href="global.html#createQuestion">createQuestion</a></li><li><a href="global.html#createToken">createToken</a></li><li><a href="global.html#deleteQuestion">deleteQuestion</a></li><li><a href="global.html#deleteVideo">deleteVideo</a></li><li><a href="global.html#forgetPassword">forgetPassword</a></li><li><a href="global.html#getCourses">getCourses</a></li><li><a href="global.html#getEnrolledCourses">getEnrolledCourses</a></li><li><a href="global.html#getEnrolledUsers">getEnrolledUsers</a></li><li><a href="global.html#getExercises">getExercises</a></li><li><a href="global.html#getLoggedInUser">getLoggedInUser</a></li><li><a href="global.html#getQuestions">getQuestions</a></li><li><a href="global.html#getVideo">getVideo</a></li><li><a href="global.html#googleSignin">googleSignin</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#resetPassword">resetPassword</a></li><li><a href="global.html#scoreAnswers">scoreAnswers</a></li><li><a href="global.html#signToken">signToken</a></li><li><a href="global.html#signup">signup</a></li><li><a href="global.html#updateQuestion">updateQuestion</a></li><li><a href="global.html#updateVideo">updateVideo</a></li><li><a href="global.html#uploadVideo">uploadVideo</a></li><li><a href="global.html#verifyEmail">verifyEmail</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.0</a> on Tue Jan 03 2023 17:27:59 GMT+0100 (West Africa Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
